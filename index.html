<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root {
    --bg: #ffffff;
    --text: #111;
}

body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    overflow: hidden;
}

.soul-orb {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: radial-gradient(circle, #000 25%, transparent 70%);
    animation: breathe 4s infinite ease-in-out;
    margin-bottom: 24px;
}

.soul-orb.listening { animation: pulse 1.2s infinite; }
.soul-orb.speaking { animation: vibrate .15s infinite; }

@keyframes breathe {
    0%,100%{transform:scale(1);opacity:.6}
    50%{transform:scale(1.05);opacity:.3}
}
@keyframes pulse {
    0%{transform:scale(1)}
    50%{transform:scale(1.12)}
    100%{transform:scale(1)}
}
@keyframes vibrate {
    0%{transform:translate(0)}
    25%{transform:translate(-1px,1px)}
    50%{transform:translate(1px,-1px)}
    75%{transform:translate(-1px,-1px)}
    100%{transform:translate(0)}
}

#status { font-size:14px; opacity:.6 }
#transcript {
    font-size:12px;
    opacity:.5;
    max-width:85%;
    text-align:center;
    white-space:pre-wrap;
}
</style>
</head>

<body>

<div id="orb" class="soul-orb"></div>
<div id="status">Инициализация…</div>
<div id="transcript"></div>

<script>
/* ---------- TELEGRAM SAFE ---------- */
const tg = window.Telegram?.WebApp || null;
if (tg) tg.expand();

/* ---------- ELEMENTS ---------- */
const orb = document.getElementById("orb");
const status = document.getElementById("status");
const transcript = document.getElementById("transcript");

/* ---------- SPEECH ---------- */
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
const rec = new SR();
rec.lang = "ru-RU";
rec.interimResults = false;
rec.continuous = false;

const synth = speechSynthesis;
let speaking = false;
let listening = false;

/* ---------- LISTEN ---------- */
function startListening(){
    if (speaking || listening) return;
    try {
        listening = true;
        rec.start();
        orb.classList.add("listening");
        status.textContent = "Listening…";
    } catch {}
}

rec.onresult = e => {
    const text = e.results[0][0].transcript;
    transcript.textContent = "Вы: " + text;
    respond(text);
};

rec.onend = () => {
    listening = false;
    orb.classList.remove("listening");
    if (!speaking) setTimeout(startListening, 900);
};

rec.onerror = () => {
    listening = false;
    setTimeout(startListening, 1500);
};

/* ---------- LOCAL BRAIN (Pages-safe) ---------- */
function localBrain(){
    const replies = [
        "Я здесь.",
        "Я слышу тебя.",
        "Продолжай.",
        "Я с тобой.",
        "Я думаю."
    ];
    return replies[Math.floor(Math.random()*replies.length)];
}

/* ---------- RESPOND ---------- */
function respond(text){
    speaking = true;
    orb.classList.add("speaking");
    status.textContent = "Thinking…";

    setTimeout(()=>{
        const reply = localBrain(text);
        transcript.textContent += "\n\nAI: " + reply;
        speak(reply);
    }, 600);
}

/* ---------- SPEAK ---------- */
function speak(text){
    status.textContent = "Speaking…";

    const u = new SpeechSynthesisUtterance(text);
    u.lang = "ru-RU";
    u.rate = 1.05;
    u.pitch = .95;

    u.onend = () => {
        speaking = false;
        orb.classList.remove("speaking");
        status.textContent = "Listening…";
        startListening();
    };

    synth.speak(u);
}

/* ---------- START ---------- */
window.addEventListener("load",()=>{
    setTimeout(startListening, 1200);
});
</script>

</body>
</html>
